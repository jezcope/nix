#!/usr/bin/env nix-shell
#!nix-shell -i bash
set -euo pipefail

cd "$(dirname "$0")"

# Generate a ssh key-pair
if [[ ! -f "id_rsa.pub" ]]; then
  ssh-keygen -q -t rsa -f id_rsa -N ""
fi

# Prepare the disk image
out=$(nix-build -A prepare)

# Setup the VM configuration on boot
img=disk.qcow2
userdata=userdata.qcow2

cp --reflink=auto "$out/disk.qcow2" "$img"
cp --reflink=auto "$out/userdata.qcow2" "$userdata"
chmod +w disk.qcow2 userdata.qcow2

# And finally boot qemu with a bunch of arguments

path=$(cd .. && pwd -P)

args=(
  -nographic
  -drive "file=${img},format=qcow2"
  -drive "file=${userdata},format=qcow2"
  -device rtl8139,netdev=net0
  -enable-kvm
  -m 2G
  -netdev user,id=net0,hostfwd=tcp:127.0.0.1:10022-:22
  -serial mon:stdio
  -smp 2
  -loadvm prepare
  #-vga virtio
  # Share the nix folder with the guest
  -virtfs local,security_model=passthrough,id=fsdev0,path=$path,readonly,mount_tag=hostshare
)

echo "Starting VM."
echo "To login: ubuntu / ubuntu"
echo "To quit: type 'Ctrl+a c' then 'quit'"
echo "Press enter in a few seconds"
set +x
exec qemu-system-x86_64 "${args[@]}"
